{% extends 'dashboard/base.html' %}
{% load static %}
{% load l10n %}

{% block title %}Minha Carteira - Rovema{% endblock %}

{% block extra_css %}
<style>
    /* KPIs de Meta */
    .kpi-progress h3 { margin: 0 0 10px 0; }
    .progress-bar {
        width: 100%;
        background-color: var(--bs-light);
        border-radius: 10px;
        height: 20px;
        overflow: hidden;
    }
    .progress-bar-inner {
        height: 100%;
        background-color: var(--bs-primary);
        width: {% if kpi_percentual_meta > 100 %}100{% else %}{{ kpi_percentual_meta }}{% endif %}%;
        border-radius: 10px;
        transition: width 0.5s ease;
    }
    .kpi-progress p {
        font-weight: 600;
        margin: 10px 0 0;
    }
    
    .card-inativos .table {
        margin-bottom: 0; 
    }
    
    /* (NOVO) Cor verde para o KPI de comiss√£o */
    .kpi-commission .h2 {
        color: var(--bs-success) !important;
    }
    /* No modo escuro, usamos um verde mais claro */
    [data-bs-theme="dark"] .kpi-commission .h2 {
        color: #20c997 !important; 
    }
</style>
{% endblock %}

{% block content %}
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form method="GET" action="{% url 'minha_carteira' %}" class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label for="start_date" class="form-label fw-bold">Data Inicial:</label>
                    <input type="date" id="start_date" name="start_date" value="{{ current_start_date }}" class="form-control">
                </div>
                <div class="col-md-4">
                    <label for="end_date" class="form-label fw-bold">Data Final:</label>
                    <input type="date" id="end_date" name="end_date" value="{{ current_end_date }}" class="form-control">
                </div>
                <div class="col-md-auto">
                    <button type="submit" class="btn btn-primary w-100">Aplicar Filtros</button>
                </div>
            </form>
        </div>
    </div>

    <div class="mb-3">
        <h1>{% if user.role == "manager" %}Performance da Equipa{% else %}Minha Carteira{% endif %}</h1>
        <p class="lead text-muted">Exibindo performance de {{ start_date_display }} at√© {{ end_date_display }}</p>
    </div>

    <div class="row">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card shadow-sm h-100 kpi-card" title="Receita L√≠quida (Lucro) gerada no per√≠odo selecionado.">
                <div class="card-body">
                    <h6 class="text-uppercase text-muted small">Receita L√≠quida (Per√≠odo)</h6>
                    <span class="h2 fw-bold">R$ {{ kpi_revenue_net|localize }}</span>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card shadow-sm h-100 kpi-card" title="N√∫mero de clientes √∫nicos que fizeram pelo menos uma compra no per√≠odo.">
                <div class="card-body">
                    <h6 class="text-uppercase text-muted small">Clientes Ativados (Per√≠odo)</h6>
                    <span class="h2 fw-bold">{{ kpi_clients_activated|localize }}</span>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card shadow-sm h-100 kpi-card" title="N√∫mero total de clientes na sua carteira (ou da sua equipa).">
                <div class="card-body">
                    <h6 class="text-uppercase text-muted small">Total na Carteira</h6>
                    <span class="h2 fw-bold">{{ kpi_total_clients|localize }}</span>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card shadow-sm h-100 kpi-card kpi-commission" 
                 title="Comiss√£o estimada com base na Receita L√≠quida do M√äS DA DATA INICIAL ({{ meta_date_object|date:"F" }})">
                <div class="card-body">
                    <h6 class="text-uppercase text-muted small">Comiss√£o ({{ meta_date_object|date:"F" }})</h6>
                    <span class="h2 fw-bold">R$ {{ kpi_commission_mes|localize }}</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="{% if user.role == "manager" %}col-lg-5{% else %}col-lg-12{% endif %} mb-4">
            <div class="card shadow-sm kpi-progress h-100">
                <div class="card-body">
                    <h5 class="card-title">Meta ({{ meta_date_object|date:"F"|capfirst }} / {{ meta_date_object.year }})</h5>
                    <div class="progress-bar">
                        <div class="progress-bar-inner" style="width: {% if kpi_percentual_meta > 100 %}100{% else %}{{ kpi_percentual_meta }}{% endif %}%;"></div>
                    </div>
                    <p class="h5 mt-2">
                        R$ {{ kpi_revenue_mes|localize }} de R$ {{ kpi_meta_mes|localize }}
                        <span class="text-muted h6">({{ kpi_percentual_meta|floatformat:1 }}%)</span>
                    </p>
                </div>
            </div>
        </div>
        
        {% if user.role == "manager" %}
        <div class="col-lg-7 mb-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Performance da Equipa ({{ meta_date_object|date:"F"|capfirst }} / {{ meta_date_object.year }})</h5>
                    <div class="table-responsive">
                        <table class="table table-hover interactive-datatable">
                            <thead>
                                <tr>
                                    <th>Consultor</th>
                                    <th>Meta</th>
                                    <th>Realizado</th>
                                    <th>% Atingido</th>
                                    <th class="text-end">Comiss√£o</th> </tr>
                            </thead>
                            <tbody>
                                {% for consultor in performance_equipa %}
                                <tr>
                                    <td>{{ consultor.first_name }} {{ consultor.last_name }}</td>
                                    <td>R$ {{ consultor.goal_month|localize }}</td>
                                    <td>R$ {{ consultor.revenue_month|localize }}</td>
                                    <td>{{ consultor.percent_atingido|floatformat:1 }}%</td>
                                    <td class="text-end fw-bold">R$ {{ consultor.commission_total|localize }}</td> </tr>
                                {% empty %}
                                <tr><td colspan="5" class="text-center text-muted">Nenhum consultor na sua equipa.</td></tr> {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Receita L√≠quida (√öltimos 12 Meses)</h5>
                    <div id="lineChart" style="width: 100%; height: 350px;"></div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Performance por Cliente (no per√≠odo)</h5>
                    <div class="table-responsive">
                        <table class="table table-hover interactive-datatable">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>CNPJ</th>
                                    <th class="text-end">Receita no Per√≠odo</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for cliente in clientes_performance %}
                                <tr>
                                    <td>
                                        <a href="{% url 'client_detail' cliente.cnpj %}">
                                            {{ cliente.client_name }}
                                        </a>
                                    </td>
                                    <td>{{ cliente.cnpj }}</td>
                                    <td class="text-end fw-bold">R$ {{ cliente.revenue_periodo|localize }}</td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="3" class="text-center text-muted">Nenhum cliente encontrado.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card shadow-sm card-inativos border-warning">
                <div class="card-header bg-warning-subtle">
                    <h5 class="card-title mb-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation-triangle-fill" viewBox="0 0 16 16" style="margin-top: -3px;">
                          <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5m.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2"/>
                        </svg>
                        Alerta: Clientes Inativos (sem compra > {{ inactive_days }} dias)
                    </h5>
                </div>
                <div class="card-body">
                    {% if not clientes_inativos %}
                        <p class="text-success fw-bold mb-0">üéâ Excelente! Nenhum cliente inativo encontrado na sua carteira.</p>
                    {% else %}
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-hover table-sm">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>CNPJ</th>
                                    {% if user.role == "manager" %}<th>Consultor</th>{% endif %}
                                    <th class="text-end">√öltima Venda</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for cliente in clientes_inativos %}
                                <tr>
                                    <td>
                                        <a href="{% url 'client_detail' cliente.cnpj %}">
                                            {{ cliente.client_name }}
                                        </a>
                                    </td>
                                    <td>{{ cliente.cnpj }}</td>
                                    {% if user.role == "manager" %}
                                        <td>{{ cliente.consultant.first_name|default:"N/A" }}</td>
                                    {% endif %}
                                    <td class="text-end">
                                        {% if cliente.last_sale_date %}
                                            {{ cliente.last_sale_date|date:"d/m/Y" }}
                                        {% else %}
                                            <span class="text-danger fw-bold">Nunca comprou</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
{% endblock %}

{% block extra_js %}
<script src="https://cdn.amcharts.com/lib/5/index.js"></script>
<script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Dark.js"></script>

<script>
    var lineChartData = JSON.parse('{{ line_chart_json|safe }}');
    var lineChartRoot = null;

    function applyLineTheme(theme) {
        if (!lineChartRoot) return;

        var themes = [am5themes_Animated.new(lineChartRoot)];
        if (theme === 'dark') {
            themes.push(am5themes_Dark.new(lineChartRoot));
            lineChartRoot.interfaceColors.set("text", am5.color(0xdee2e6));
            lineChartRoot.interfaceColors.set("grid", am5.color(0x495057));
        } else {
            lineChartRoot.interfaceColors.set("text", am5.color(0x000000));
            lineChartRoot.interfaceColors.set("grid", am5.color(0xdee2e6));
        }
        lineChartRoot.setThemes(themes);
    }

    window.addEventListener('themeChanged', function(e) {
        applyLineTheme(e.detail.theme);
    });

    am5.ready(function() {
        lineChartRoot = am5.Root.new("lineChart");
        
        var currentTheme = document.documentElement.getAttribute('data-bs-theme');
        applyLineTheme(currentTheme);
        
        lineChartRoot.numberFormatter.set("numberFormat", "R$ #,###.00");
        var chart = lineChartRoot.container.children.push(am5xy.XYChart.new(lineChartRoot, {
            panX: false, panY: false, wheelX: "none", wheelY: "none"
        }));
        var cursor = chart.set("cursor", am5xy.XYCursor.new(lineChartRoot, {}));
        cursor.lineY.set("visible", false);
        var xAxis = chart.xAxes.push(am5xy.DateAxis.new(lineChartRoot, {
            baseInterval: { timeUnit: "month", count: 1 },
            renderer: am5xy.AxisRendererX.new(lineChartRoot, {}),
            tooltip: am5.Tooltip.new(lineChartRoot, {})
        }));
        var yAxis = chart.yAxes.push(am5xy.ValueAxis.new(lineChartRoot, {
            renderer: am5xy.AxisRendererY.new(lineChartRoot, {}),
            tooltip: am5.Tooltip.new(lineChartRoot, {})
        }));
        var series = chart.series.push(am5xy.LineSeries.new(lineChartRoot, {
            name: "Receita", xAxis: xAxis, yAxis: yAxis,
            valueYField: "revenue", valueXField: "date",
            tooltip: am5.Tooltip.new(lineChartRoot, { labelText: "{valueY}" })
        }));
        series.strokes.template.setAll({
            strokeColor: am5.color(0x0068C9), strokeWidth: 3
        });
        series.fills.template.setAll({
            fillOpacity: 0.1, visible: true,
            fillPattern: am5.LinearGradient.new(lineChartRoot, {
                stops: [
                    { color: am5.color(0x0068C9), opacity: 0.5 },
                    { color: am5.color(0x0068C9), opacity: 0 }
                ],
                rotation: 90
            })
        });
        series.data.processor = am5.DataProcessor.new(lineChartRoot, {
            dateFields: ["date"], dateFormat: "yyyy-MM-dd"
        });
        series.bullets.push(function() {
            return am5.Bullet.new(lineChartRoot, {
                sprite: am5.Circle.new(lineChartRoot, {
                    radius: 5, fill: series.get("fill"),
                    stroke: lineChartRoot.interfaceColors.get("background"), strokeWidth: 2
                })
            });
        });
        series.data.setAll(lineChartData);
    });
</script>
{% endblock %}